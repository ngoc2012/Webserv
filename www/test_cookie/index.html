<!DOCTYPE html>
<html>
    <head>
        <title>Blip Bloup</title>
    </head>
    <body>
        <h1>Blip Bloup</h1>
        <button id="button" onclick="send_get_request('signup')">signup</button>
        <button id="button" onclick="send_get_request('signout')">signout</button>
        Login: <input name="searchTxt" type="text" maxlength="512" id="login"/>
        Password: <input name="searchTxt" type="text" maxlength="512" id="password"/>
        <ul></ul>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <script>
            //                    body: JSON.stringify('{ "action": "signup", "name": "bubulle2", "password": "1234" }'),
            document.cookie = "session_id=123456; expires=Thu, 01 Jan 2025 00:00:00 UTC; path=/; SameSite=None; Secure";
            var setCookieHeader;

            function send_get_request(action)
            {
                login = document.getElementById('login').value;
                password = document.getElementById('password').value;
                const data = {
                    "action": action,
                    "name": login,
                    "password": password
                };
                fetch("http://127.0.0.1:4141/login.js", {
                    method: 'POST',
                    headers: {'Cookie': document.cookie},
                    credentials: 'include',
                    contentType: 'application/json',
                    body: JSON.stringify(data),
                    crossDomain: true,
                })
                .then(response => {
                    setCookieHeader = response.headers.get('set-cookies');
                    console.log('Cook first', setCookieHeader);
                    return response.json(); // Parse JSON data
                })
                .then(data => {
                    console.log(data["input"]);
                    //const setCookieHeader = data.headers.get('set-cookies');
                    //const setCookieHeader = "session_id=1; path=/"
                    //console.log(response);
                    //console.log(setCookieHeader);
                    //console.log(document.cookie);
                    
                    if (setCookieHeader)
                    {
                        cookies = parseCookies(setCookieHeader);
                        console.log("Cookie found - token: " + cookies.session_id);
                        document.cookie = "session_id=" + cookies.session_id + "; expires=Thu, 01 Jan 2025 00:00:00 UTC; path=/; SameSite=None; Secure";
                        //console.log(document.cookie);
                    }
                    else
                        console.log("No cookies");
                    

                })
                .catch(error => {console.log('Catch', error)});
            }

            function parseCookies(setCookieHeader) {
              return setCookieHeader
                .split(';')
                .map(cookie => cookie.trim().split('='))
                .reduce((acc, [key, value]) => {
                  acc[key] = value;
                  return acc;
                }, {});
            }

        </script>
    </body>
</html>
